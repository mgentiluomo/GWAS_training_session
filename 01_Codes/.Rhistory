View(PCA)
# Load PCA eigenvectors
PCA <- read.delim("03_PCA/PCA.eigenvec", quote = "",)
num_pca_columns <- ncol(PCA) - 2
colnames(PCA) <- c("FID", "IID", paste0("PC", 1:num_pca_columns))
View(PCA)
general_covar <- read.delim("F:/OneDrive - University of Pisa/Desktop/Class_folder/01_Database/general_covar.txt", quote="")
View(general_covar)
# Import study population covariates, such as sex, phenotype (likely already updated in the .fam file), age, BMI, etc.
COV <- read.delim("02_Database/general_covar.txt", quote = "")
View(COV)
FAM <- read.table("02_QC/QC9_hwe.fam", quote="", comment.char="")
names(FAM) <- c("FID","IID","f","m","sex","pheno")
View(FAM)
FAM <- FAM %>%
mutate(pheno = case_when(
pheno == 2 ~ "Case",
pheno == 1 ~ "Control",
TRUE ~ NA_character_
))
View(FAM)
ID_label <- merge(COV, FAM %>% select(FID, IID, pheno), by = c("FID", "IID"), all.x = TRUE)
View(ID_label)
View(ID_label)
# Unisci i dati di Paese (ID_label) e di stato (FAM)
ID_label <- merge(COV, FAM %>% select(FID, IID, pheno), by = c("FID", "IID"), all.y = TRUE)
View(ID_label)
# Caricamento e preparazione dei dati di stato (pheno)
FAM <- read.table("02_QC/QC9_hwe.fam", quote="", comment.char="")
names(FAM) <- c("FID","IID","f","m","sex","phenotype")
FAM <- FAM %>%
mutate(pheno = case_when(
pheno == 2 ~ "Case",
pheno == 1 ~ "Control",
TRUE ~ NA_character_
))
View(ID_label)
# Caricamento e preparazione dei dati di stato (pheno)
FAM <- read.table("02_QC/QC9_hwe.fam", quote="", comment.char="")
names(FAM) <- c("FID","IID","f","m","sex","phenotype")
FAM <- FAM %>%
mutate(pheno = case_when(
phenotype == 2 ~ "Case",
phenotype == 1 ~ "Control",
TRUE ~ NA_character_
))
# Unisci i dati di Paese (ID_label) e di stato (FAM)
ID_label <- merge(COV, FAM %>% select(FID, IID, pheno), by = c("FID", "IID"), all.y = TRUE)
View(ID_label)
ID_label <- dplyr::select(ID_label, c("FID", "IID", "BMI", "pheno"))
# Caricamento e preparazione dei dati di stato (pheno)
FAM <- read.table("02_QC/QC9_hwe.fam", quote="", comment.char="")
names(FAM) <- c("FID","IID","f","m","sex","phenotype")
FAM <- FAM %>%
mutate(phenotype = case_when(
phenotype == 2 ~ "Case",
phenotype == 1 ~ "Control",
TRUE ~ NA_character_
))
# Unisci i dati di Paese (ID_label) e di stato (FAM)
ID_label <- merge(COV, FAM %>% select(FID, IID, pheno), by = c("FID", "IID"), all.y = TRUE)
# Caricamento e preparazione dei dati di stato (pheno)
FAM <- read.table("02_QC/QC9_hwe.fam", quote="", comment.char="")
names(FAM) <- c("FID","IID","f","m","sex","phenotype")
FAM <- FAM %>%
mutate(phenotype = case_when(
phenotype == 2 ~ "Case",
phenotype == 1 ~ "Control",
TRUE ~ NA_character_
))
# Unisci i dati di Paese (ID_label) e di stato (FAM)
ID_label <- merge(COV, FAM %>% select(FID, IID, pheno), by = c("FID", "IID"), all.y = TRUE)
# Caricamento e preparazione dei dati di stato (pheno)
FAM <- read.table("02_QC/QC9_hwe.fam", quote="", comment.char="")
names(FAM) <- c("FID","IID","f","m","sex","phenotype")
FAM <- FAM %>%
mutate(phenotype = case_when(
phenotype == 2 ~ "Case",
phenotype == 1 ~ "Control",
TRUE ~ NA_character_
))
# Unisci i dati di Paese (ID_label) e di stato (FAM)
ID_label <- merge(COV, FAM %>% select(FID, IID, phenotype), by = c("FID", "IID"), all.y = TRUE)
ID_label <- dplyr::select(ID_label, c("FID", "IID", "BMI", "phenotype"))
View(COV)
# Caricamento e preparazione dei dati di stato (pheno)
FAM <- read.table("02_QC/QC9_hwe.fam", quote="", comment.char="")
names(FAM) <- c("FID","IID","f","m","sex","phenotype")
# Unisci i dati di Paese (ID_label) e di stato (FAM)
ID_label <- merge(COV, FAM %>% select(FID, IID, phenotype), by = c("FID", "IID"), all.y = TRUE)
ID_label <- dplyr::select(ID_label, c("FID", "IID", "BMI", "phenotype"))
View(ID_label)
# Caricamento e preparazione dei dati di stato (pheno)
FAM <- read.table("02_QC/QC9_hwe.fam", quote="", comment.char="")
names(FAM) <- c("FID","IID","f","m","sex","phenotype")
# Unisci i dati di Paese (ID_label) e di stato (FAM)
ID_label <- merge(COV, FAM %>% select(FID, IID, phenotype), by = c("FID", "IID"), all.y = TRUE)
View(ID_label)
# Caricamento e preparazione dei dati di stato (pheno)
FAM <- read.table("02_QC/QC9_hwe.fam", quote="", comment.char="")
names(FAM) <- c("FID","IID","f","m","sex","phenotype")
# Unisci i dati di Paese (ID_label) e di stato (FAM)
ID_label <- merge(COV, FAM %>% select(FID, IID, phenotype), by = c("FID", "IID"), all.y = TRUE)
ID_label <- dplyr::select(ID_label, c("FID", "IID", "BMI", "pheno"))
View(ID_label)
# Unisci i risultati PCA con i dati delle etichette
dfPCA <- merge(PCA, ID_label, by = c("FID", "IID"), all.x = TRUE)
View(dfPCA)
# Assicurati che 'country' e 'pheno' siano fattori per la visualizzazione
dfPCA$pheno <- as.factor(dfPCA$pheno) # Usiamo pheno come colonna di stato/colore
library(dplyr)
library(stringr) # Required for str_detect
# Loading and preparing phenotype data (pheno)
FAM <- read.table("02_QC/QC9_hwe.fam", quote = "", comment.char = "")
names(FAM) <- c("FID", "IID", "f", "m", "sex", "phenotype")
# Merge country data (ID_label) and phenotype data (FAM)
ID_label <- merge(COV, FAM %>% select(FID, IID, phenotype),
by = c("FID", "IID"), all.y = TRUE)
ID_label <- dplyr::select(ID_label, c("FID", "IID", "BMI", "pheno"))
# Merge PCA results with label data
dfPCA <- merge(PCA, ID_label, by = c("FID", "IID"), all.x = TRUE)
# Ensure that 'country' and 'pheno' are factors for plotting
dfPCA$pheno <- as.factor(dfPCA$pheno) # Use pheno as the status/colour column
library(dplyr)
library(stringr) # Required for str_detect
# Loading and preparing phenotype data (pheno)
FAM <- read.table("02_QC/QC9_hwe.fam", quote = "", comment.char = "")
names(FAM) <- c("FID", "IID", "f", "m", "sex", "phenotype")
# Merge country data (ID_label) and phenotype data (FAM)
ID_label <- merge(COV, FAM %>% select(FID, IID, phenotype),
by = c("FID", "IID"), all.y = TRUE)
# Set of 5 European countries (3-letter codes)
countries <- c("ITA", "FRA", "DEU", "ESP", "GBR")
# Add a random country to each row of ID_label
set.seed(123)  # Optional, for reproducibility
ID_label$country <- sample(countries, size = nrow(ID_label), replace = TRUE)
View(ID_label)
library(dplyr)
library(stringr) # Required for str_detect
# Loading and preparing phenotype data (pheno)
FAM <- read.table("02_QC/QC9_hwe.fam", quote = "", comment.char = "")
names(FAM) <- c("FID", "IID", "f", "m", "sex", "phenotype")
# Merge country data (ID_label) and phenotype data (FAM)
ID_label <- merge(COV, FAM %>% select(FID, IID, phenotype),
by = c("FID", "IID"), all.y = TRUE)
# Set of 5 European countries (3-letter codes)
countries <- c("ITA", "FRA", "DEU", "ESP", "GBR")
# Add a random country to each row of ID_label
set.seed(123)  # Optional, for reproducibility
ID_label$country <- sample(countries, size = nrow(ID_label), replace = TRUE)
ID_label <- dplyr::select(ID_label, c("FID", "IID", "country", "pheno"))
# Merge PCA results with label data
dfPCA <- merge(PCA, ID_label, by = c("FID", "IID"), all.x = TRUE)
# Ensure that 'country' and 'pheno' are factors for plotting
dfPCA$pheno <- as.factor(dfPCA$pheno) # Use pheno as the status/colour column
dfPCA$country <- as.factor(dfPCA$country) # Use pheno as the status/colour column
View(ID_label)
View(ID_label)
### 3. Visualizzazione PCA (Colore per Status, Forma per Paese)
# Calcola la varianza spiegata (per le etichette degli assi)
explained_var <- as.vector(round(slice(dplyr::select(PCA_val, c("ExplainedVariance")), c(1,2))*100, digits = 2)$ExplainedVariance)
# Esegui la PCA per ottenere l'oggetto 'pca_res' necessario per autoplot
pca_res <- prcomp(dplyr::select(dfPCA, starts_with("PC")), scale. = TRUE)
# Crea il grafico finale
plot_final <- autoplot(pca_res, data = dfPCA,
colour = "pheno",  # <--- COLORE basato sullo Stato (Case/Control)
shape = "country",  # <--- FORMA basata sul Paese
size = 3) +
theme_bw() +
# Aggiungi etichette degli assi
xlab(paste("PC1 (", explained_var[1], "%)", sep="")) +
ylab(paste("PC2 (", explained_var[2], "%)", sep="")) +
# Titolo del grafico
ggtitle("PCA: Country (Shape) vs. Case/Control Status (Color)") +
# Personalizza i COLORI (opzionale, assegna colori specifici a Case/Control)
scale_color_manual(name = "Status",
values = c("Case" = "red",       # Esempio: Casse in Rosso
"Control" = "blue")) +  # Esempio: Controlli in Blu
# Personalizza le FORME (il numero di forme disponibili è limitato; ne userà una per ogni Paese)
# Se hai molti Paesi, ggplot2 userà automaticamente fino a 6 o 7 forme diverse prima di ricominciare.
# Se vuoi specificare un set più ampio:
# scale_shape_manual(name = "Country",
#                    values = c(15, 16, 17, 18, 19, 20, 21, 22, 23, 24)) +
# Personalizza l'aspetto della legenda
theme(legend.position = "right",
plot.title = element_text(size = 14, face = "bold"),
legend.title = element_text(size = 10, face = "bold"))
# Salva il plot
ggsave(filename = paste("03_PCA/","pca_status_country_swapped",timestamp,".jpeg", sep=""), plot = plot_final, width = 10, height = 7, dpi = 600)
View(ID_label)
library(readxl)
oneTGenome <- read_excel("F:/OneDrive - University of Pisa/Desktop/Class_folder/02_Database/DB_1K_genome/1000G_individuals.xlsx",
col_names = FALSE)
View(oneTGenome)
rm(oneTGenome)
#Import 1000Genome data info
oneTGenome <- read_excel("02_Database/DB_1K_genome/1000G_individuals.xlsx", col_names = FALSE)
View(oneTGenome)
names(oneTGenome) <- c("FID","IID","Population")
# Define the target directory
DB_dir <- file.path(main, "01_Database/DB_1K_genome")
# Define URLs (raw GitHub links)
files_to_download <- list(
bed_1KG   = "https://unipiit-my.sharepoint.com/:u:/g/personal/a035503_unipi_it/IQCMZbnTFipoRYVs_2tIdGk0ARoMtzCjqQ7mh-NY3QT5EG0?e=jYeGS4",
fam_1KG = "https://github.com/mgentiluomo/GWAS_training_session/blob/main/02_Database/DB_1K_genome/DB_1000G.fam",
bim_1KG = "https://github.com/mgentiluomo/GWAS_training_session/blob/main/02_Database/DB_1K_genome/DB_1000G.fam",
info_1KG= "https://github.com/mgentiluomo/GWAS_training_session/blob/main/02_Database/DB_1K_genome/1000G_individuals.xlsx"
)
# Loop to download each file
for (name in names(files_to_download)) {
dest_file <- file.path(DB_dir, basename(files_to_download[[name]]))
# Download file if it doesn't already exist
if (!file.exists(dest_file)) {
message("⬇️ Downloading ", name, " file...")
download.file(files_to_download[[name]], destfile = dest_file, mode = "wb")
} else {
message("✅ File already exists: ", basename(dest_file))
}
}
# Define the target directory
DB_dir <- file.path(main, "01_Database", "DB_1K_genome")
dir.create(DB_dir, recursive = TRUE, showWarnings = FALSE)
# Define URLs and destination file names
files_to_download <- list(
bed_1KG = list(
url  = "https://unipiit-my.sharepoint.com/:u:/g/personal/a035503_unipi_it/IQCMZbnTFipoRYVs_2tIdGk0ARoMtzCjqQ7mh-NY3QT5EG0?e=jYeGS4",
dest = "DB_1000G.bed"
),
fam_1KG = list(
url  = "https://raw.githubusercontent.com/mgentiluomo/GWAS_training_session/ba69c0ef61926cc7d1d8a06761aa35ad70f94777/02_Database/DB_1K_genome/DB_1000G.fam",
dest = "DB_1000G.fam"
),
bim_1KG = list(
url  = "https://raw.githubusercontent.com/mgentiluomo/GWAS_training_session/ba69c0ef61926cc7d1d8a06761aa35ad70f94777/02_Database/DB_1K_genome/DB_1000G.bim",
dest = "DB_1000G.bim"
),
info_1KG = list(
url  = "https://raw.githubusercontent.com/mgentiluomo/GWAS_training_session/ba69c0ef61926cc7d1d8a06761aa35ad70f94777/02_Database/DB_1K_genome/1000G_individuals.xlsx",
dest = "1000G_individuals.xlsx"
)
)
# Loop to download each file
for (name in names(files_to_download)) {
url       <- files_to_download[[name]]$url
dest_name <- files_to_download[[name]]$dest
dest_file <- file.path(DB_dir, dest_name)
if (!file.exists(dest_file)) {
message("⬇️ Downloading ", name, " file (", dest_name, ") ...")
download.file(url, destfile = dest_file, mode = "wb")
} else {
message("✅ File already exists: ", dest_name)
}
}
# Define the target directory
DB_dir <- file.path(main, "02_Database", "DB_1K_genome")
dir.create(DB_dir, recursive = TRUE, showWarnings = FALSE)
# Define URLs and destination file names
files_to_download <- list(
bed_1KG = list(
url  = "https://unipiit-my.sharepoint.com/:u:/g/personal/a035503_unipi_it/IQCMZbnTFipoRYVs_2tIdGk0ARoMtzCjqQ7mh-NY3QT5EG0?e=jYeGS4",
dest = "DB_1000G.bed"
),
fam_1KG = list(
url  = "https://raw.githubusercontent.com/mgentiluomo/GWAS_training_session/ba69c0ef61926cc7d1d8a06761aa35ad70f94777/02_Database/DB_1K_genome/DB_1000G.fam",
dest = "DB_1000G.fam"
),
bim_1KG = list(
url  = "https://raw.githubusercontent.com/mgentiluomo/GWAS_training_session/ba69c0ef61926cc7d1d8a06761aa35ad70f94777/02_Database/DB_1K_genome/DB_1000G.bim",
dest = "DB_1000G.bim"
),
info_1KG = list(
url  = "https://raw.githubusercontent.com/mgentiluomo/GWAS_training_session/ba69c0ef61926cc7d1d8a06761aa35ad70f94777/02_Database/DB_1K_genome/1000G_individuals.xlsx",
dest = "1000G_individuals.xlsx"
)
)
# Loop to download each file
for (name in names(files_to_download)) {
url       <- files_to_download[[name]]$url
dest_name <- files_to_download[[name]]$dest
dest_file <- file.path(DB_dir, dest_name)
if (!file.exists(dest_file)) {
message("⬇️ Downloading ", name, " file (", dest_name, ") ...")
download.file(url, destfile = dest_file, mode = "wb")
} else {
message("✅ File already exists: ", dest_name)
}
}
#Import 1000Genome data info
oneTGenome <- read_excel("02_Database/DB_1K_genome/1000G_individuals.xlsx", col_names = FALSE)
names(oneTGenome) <- c("FID","IID","Population")
# SECTION 6: Cryptic relatedness check
# Step 1: Prune SNPs for PCA analysis.
system(paste(plink_command, " --bfile 02_QC/QC9_hwe,
--bmerge  02_Database/DB_1K_genome/  50 5 0.2 --out 03_PCA/Pruned_list_to_PCA"))
# STEP 2: Extraction of independent SNPs
system(paste(plink_command," --bfile 02_QC/QC9_hwe --extract 03_PCA/Pruned_list_to_PCA.prune.in --make-bed --out 03_PCA/DB_to_PCA"))
# STEP 8: PCA calculation
system(paste(plink_command," --bfile 03_PCA/DB_to_PCA --pca --out 03_PCA/PCA"))
# Define the target directory
DB_dir <- file.path(main, "02_Database", "DB_1K_genome")
dir.create(DB_dir, recursive = TRUE, showWarnings = FALSE)
# Define URLs and destination file names
files_to_download <- list(
bed_1KG = list(
url  = "https://unipiit-my.sharepoint.com/:u:/g/personal/a035503_unipi_it/IQCMZbnTFipoRYVs_2tIdGk0ARoMtzCjqQ7mh-NY3QT5EG0?e=jYeGS4",
dest = "DB_1000G.bed"
),
fam_1KG = list(
url  = "https://raw.githubusercontent.com/mgentiluomo/GWAS_training_session/ba69c0ef61926cc7d1d8a06761aa35ad70f94777/02_Database/DB_1K_genome/DB_1000G.fam",
dest = "DB_1000G.fam"
),
bim_1KG = list(
url  = "https://raw.githubusercontent.com/mgentiluomo/GWAS_training_session/ba69c0ef61926cc7d1d8a06761aa35ad70f94777/02_Database/DB_1K_genome/DB_1000G.bim",
dest = "DB_1000G.bim"
),
info_1KG = list(
url  = "https://raw.githubusercontent.com/mgentiluomo/GWAS_training_session/ba69c0ef61926cc7d1d8a06761aa35ad70f94777/02_Database/DB_1K_genome/1000G_individuals.xlsx",
dest = "1000G_individuals.xlsx"
)
)
# Loop to download each file
for (name in names(files_to_download)) {
url       <- files_to_download[[name]]$url
dest_name <- files_to_download[[name]]$dest
dest_file <- file.path(DB_dir, dest_name)
if (!file.exists(dest_file)) {
message("⬇️ Downloading ", name, " file (", dest_name, ") ...")
download.file(url, destfile = dest_file, mode = "wb")
} else {
message("✅ File already exists: ", dest_name)
}
}
#Import 1000Genome data info
oneTGenome <- read_excel("02_Database/DB_1K_genome/1000G_individuals.xlsx", col_names = FALSE)
names(oneTGenome) <- c("FID","IID","Population")
# Define the target directory
DB_dir <- file.path(main, "02_Database", "DB_1K_genome")
dir.create(DB_dir, recursive = TRUE, showWarnings = FALSE)
# Define URLs and destination file names
files_to_download <- list(
bed_1KG = list(
url  = "https://unipiit-my.sharepoint.com/:u:/g/personal/a035503_unipi_it/IQCMZbnTFipoRYVs_2tIdGk0ARoMtzCjqQ7mh-NY3QT5EG0?e=jYeGS4",
dest = "DB_1000G.bed"
),
fam_1KG = list(
url  = "https://raw.githubusercontent.com/mgentiluomo/GWAS_training_session/ba69c0ef61926cc7d1d8a06761aa35ad70f94777/02_Database/DB_1K_genome/DB_1000G.fam",
dest = "DB_1000G.fam"
),
bim_1KG = list(
url  = "https://raw.githubusercontent.com/mgentiluomo/GWAS_training_session/ba69c0ef61926cc7d1d8a06761aa35ad70f94777/02_Database/DB_1K_genome/DB_1000G.bim",
dest = "DB_1000G.bim"
),
info_1KG = list(
url  = "https://raw.githubusercontent.com/mgentiluomo/GWAS_training_session/ba69c0ef61926cc7d1d8a06761aa35ad70f94777/02_Database/DB_1K_genome/1000G_individuals.xlsx",
dest = "1000G_individuals.xlsx"
)
)
# Loop to download each file
for (name in names(files_to_download)) {
url       <- files_to_download[[name]]$url
dest_name <- files_to_download[[name]]$dest
dest_file <- file.path(DB_dir, dest_name)
if (!file.exists(dest_file)) {
message("⬇️ Downloading ", name, " file (", dest_name, ") ...")
download.file(url, destfile = dest_file, mode = "wb")
} else {
message("✅ File already exists: ", dest_name)
}
}
# Step 1: Prune SNPs for PCA analysis.
system(paste(plink_command, " --bfile 02_QC/QC9_hwe",
"--bmerge  02_Database/DB_1K_genome/DB_1000G.bed",
"02_Database/DB_1K_genome/DB_1000G.bim",
"02_Database/DB_1K_genome/DB_1000G.fam",
"--out 03_PCA/DB_merged_1KG"))
# Step 1: Prune SNPs for PCA analysis.
system(paste(plink_command, " --bfile 02_QC/QC9_hwe",
"--pmerge  02_Database/DB_1K_genome/DB_1000G.bed",
"02_Database/DB_1K_genome/DB_1000G.bim",
"02_Database/DB_1K_genome/DB_1000G.fam",
"--out 03_PCA/DB_merged_1KG"))
# Step 1: Prune SNPs for PCA analysis.
system(paste(plink_command, " --bfile 02_QC/QC9_hwe",
"--merge  02_Database/DB_1K_genome/DB_1000G.bed",
"02_Database/DB_1K_genome/DB_1000G.bim",
"02_Database/DB_1K_genome/DB_1000G.fam",
"--out 03_PCA/DB_merged_1KG"))
system(paste(
plink_command,
"--bfile 02_QC/QC9_hwe",
"--merge 02_Database/DB_1K_genome/DB_1000G",
"--out 03_PCA/DB_merged_1KG"
))
system(paste(
plink_command,
"--bfile 02_QC/QC9_hwe",
"--pmerge 02_Database/DB_1K_genome/DB_1000G bfile",
"--out 03_PCA/DB_merged_1KG"
))
system(paste(
plink_command,
"--bfile 02_QC/QC9_hwe",
"--pmerge 02_Database/DB_1K_genome/DB_1000G.bed 02_Database/DB_1K_genome/DB_1000G.bim 02_Database/DB_1K_genome/DB_1000G.fam",
"--out 03_PCA/DB_merged_1KG"
))
# PLINK command setup (PLINK 2 and PLINK 1.9)
# 1. Retrieve system information
os_name <- Sys.info()[["sysname"]]
# 2. Define PLINK2 and PLINK 1.9 commands based on the operating system
if (os_name == "Windows") {
# On Windows, executables normally end with .exe
plink_command     <- "plink2.exe"  # PLINK 2 (already downloaded in the QC lesson)
plink_command_old <- "plink.exe"   # PLINK 1.9 (will be added by a later chunk)
} else if (os_name %in% c("Darwin", "Linux")) {
# 'Darwin' is the macOS kernel
# On macOS/Linux we usually run executables from the current folder with "./"
plink_command     <- "./plink2"    # PLINK 2 (already present from the QC lesson)
plink_command_old <- "./plink"     # PLINK 1.9 (will be added by a later chunk)
} else {
stop("Unsupported or unidentified operating system.")
}
# 3. Print the result for verification
cat("Detected operating system:        ", os_name, "\n")
cat("PLINK 2 command to be used:       ", plink_command, "\n")
cat("PLINK 1.9 (old) command to be used:", plink_command_old, "\n")
# --- Example usage (optional checks) ---
cat("\n--- Testing PLINK 2 (if available) ---\n")
system(paste(plink_command, "--version"))
cat("\n--- Testing PLINK 1.9 (if available) ---\n")
system(paste(plink_command_old, "--version"))
print("End of chunk 2")
# Download and prepare PLINK 1.9 (old PLINK)
# This chunk does NOT modify or overwrite plink2.
# It simply adds the plink 1.9 executable alongside it.
# Use the existing notebook directory if defined; otherwise fall back to the current working directory
if (!exists("notebook_dir")) {
notebook_dir <- getwd()
}
# Detect the operating system (reuse os_name if it already exists)
if (!exists("os_name")) {
os_name <- Sys.info()[["sysname"]]
}
# Define the PLINK 1.9 download URLs (update these if a newer build is released)
plink_url_mac     <- "https://s3.amazonaws.com/plink1-assets/plink_mac_20250819.zip"
plink_url_windows <- "https://s3.amazonaws.com/plink1-assets/plink_win64_20250819.zip"
# Choose the correct URL based on the operating system
if (os_name == "Windows") {
plink_url <- plink_url_windows
} else if (os_name == "Darwin") {
plink_url <- plink_url_mac
} else {
stop("This PLINK 1.9 download script currently supports only Windows and macOS.")
}
# Derive the ZIP file name from the URL
file_name <- basename(plink_url)
# Define the destination path for the ZIP file
dest_file <- file.path(notebook_dir, file_name)
# Download the ZIP file
message("⬇️ Downloading PLINK 1.9 from: ", plink_url)
download.file(url = plink_url, destfile = dest_file, mode = "wb")
# Confirm that the ZIP file exists
if (!file.exists(dest_file)) {
stop("Download failed: ZIP file not found at ", dest_file)
}
# Create a folder to extract the ZIP contents (named after the ZIP file, without .zip)
extract_dir <- file.path(
notebook_dir,
tools::file_path_sans_ext(basename(dest_file))
)
if (!dir.exists(extract_dir)) dir.create(extract_dir)
# Unzip the contents into extract_dir
unzip(zipfile = dest_file, exdir = extract_dir)
message("Extracted: ", basename(dest_file), " → ", extract_dir)
# Find any file inside the extracted folder that contains "plink" in its name
# (this will typically include "plink" / "plink.exe", but NOT your existing plink2)
plink_files <- list.files(
path = extract_dir,
pattern = "plink",
full.names = TRUE,
recursive = TRUE
)
# Copy each found PLINK 1.9 file back into the main notebook directory
for (pf in plink_files) {
file.copy(from = pf, to = notebook_dir, overwrite = TRUE)
message("Copied: ", basename(pf), " → ", notebook_dir)
}
# On macOS/Linux, ensure the plink 1.9 binary is executable
if (os_name != "Windows") {
plink_old_path <- file.path(notebook_dir, "plink")
if (file.exists(plink_old_path)) {
Sys.chmod(plink_old_path, mode = "0755")
message("Set executable permissions on: ", plink_old_path)
}
}
# List all PLINK-related files now present in the main notebook directory
message("PLINK-related files in the notebook directory:")
print(list.files(notebook_dir, pattern = "plink", full.names = TRUE))
plink_command
plink_command_old
# SECTION 6: Cryptic relatedness check
# Step 1: Prune SNPs for PCA analysis.
system(paste(plink_command, " --bfile 02_QC/QC9_hwe --indep-pairwise 50 5 0.2 --out 03_PCA/Pruned_list_to_PCA"))
# STEP 2: Extraction of independent SNPs
system(paste(plink_command," --bfile 02_QC/QC9_hwe --extract 03_PCA/Pruned_list_to_PCA.prune.in --make-bed --out 03_PCA/DB_to_PCA"))
# STEP 8: PCA calculation
system(paste(plink_command," --bfile 03_PCA/DB_to_PCA --pca --out 03_PCA/PCA"))
system(paste(
plink_command_old,
"--bfile 02_QC/QC9_hwe",
"--bmerge 02_Database/DB_1K_genome/DB_1000G.bed 02_Database/DB_1K_genome/DB_1000G.bim 02_Database/DB_1K_genome/DB_1000G.fam",
"--out 03_PCA/DB_merged_1KG"
))
